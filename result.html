<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resultado - LoveQuiz</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h2>Seu resultado est√° quase pronto!</h2>
    <p>Voc√™ est√° prestes a descobrir algo <strong>√∫nico e raro</strong> sobre voc√™!</p>

    <div class="special-message" id="special-message"></div>
    <button id="pay-btn">Revelar Resultado (por apenas R$3,99)</button>
    <div id="final-result"></div>
  </div>

<script>
const scores = JSON.parse(localStorage.getItem("scores")) || {};
const specialMessageEl = document.getElementById("special-message");
const finalResult = document.getElementById("final-result");
const payBtn = document.getElementById("pay-btn");

const specialMessages = [
  "ü§© Seu resultado √© EXTREMAMENTE RARO ‚Äî apenas 8% das pessoas t√™m essa linguagem do amor!",
  "üòÆ Voc√™ pertence ao grupo seleto de 10% DAS PESSOAS que possuem esse perfil!",
  "üò± Incr√≠vel! S√≥ 7% DAS PESSOAS compartilham essa linguagem do amor √∫nica!",
  "üò± Este resultado √© EXTREMAMENTE ESPECIAL ‚Äî menos de 1 em cada 10 pessoas o recebe!",
];

specialMessageEl.textContent = specialMessages[Math.floor(Math.random() * specialMessages.length)];

// FUN√á√ÉO PARA VERIFICAR STATUS DO PAGAMENTO
async function verificarPagamento(payment_id) {
  try {
    const response = await fetch(`https://lovequiz-backend.vercel.app/api/check-status?payment_id=${payment_id}`);
    const data = await response.json();
    return data.status === "approved";
  } catch (err) {
    console.error("Erro ao verificar pagamento:", err);
    return false;
  }
}

// BOT√ÉO DE PAGAMENTO
payBtn.addEventListener("click", async () => {
  payBtn.disabled = true;
  payBtn.textContent = "Redirecionando para pagamento...";

  try {
    const response = await fetch("https://lovequiz-backend.vercel.app/api/create-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ amount: 3.99 })
    });
    const data = await response.json();

    // Redireciona pro checkout do Mercado Pago
    window.location.href = data.checkout_url;

  } catch (err) {
    console.error(err);
    alert("Erro ao criar pagamento");
    payBtn.disabled = false;
    payBtn.textContent = "Ver Resultado (R$3,99)";
  }
});

// CHECA PAGAMENTO AP√ìS REDIRECIONAMENTO
const urlParams = new URLSearchParams(window.location.search);
const paymentId = urlParams.get("payment_id"); // ex: ?payment_id=12345

if(paymentId) {
  (async () => {
    payBtn.disabled = true;
    payBtn.textContent = "Verificando pagamento...";
    const pago = await verificarPagamento(paymentId);

    if(pago) {
      const maxType = Object.keys(scores).reduce((a,b) => scores[a] > scores[b] ? a : b);
      specialMessageEl.style.display = "none";
      finalResult.innerHTML = `<h3>Parab√©ns! Sua linguagem do amor √©: <strong>${maxType} ‚ù§Ô∏è</strong></h3>`;
      payBtn.style.display = "none";
    } else {
      alert("Pagamento n√£o confirmado. Tente novamente.");
      payBtn.disabled = false;
      payBtn.textContent = "Ver Resultado (R$3,99)";
    }
  })();
}
</script>
</body>
</html>
